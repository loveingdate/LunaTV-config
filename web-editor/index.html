<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ™ Luna TV é…ç½®ç¼–è¾‘å™¨ - JSON Formatter & Validator</title>
    <meta name="description" content="ä¸“ä¸šçš„JSONé…ç½®æ–‡ä»¶ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ ¼å¼åŒ–ã€éªŒè¯ã€è½¬æ¢ç­‰åŠŸèƒ½">
    <meta name="keywords" content="JSON,ç¼–è¾‘å™¨,æ ¼å¼åŒ–,éªŒè¯,Luna TV,é…ç½®">
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ™</text></svg>">
    
    <style>
        :root {
            --primary-green: #28a745;
            --primary-blue: #007bff;
            --primary-orange: #fd7e14;
            --primary-red: #dc3545;
            --primary-purple: #6f42c1;
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --bg-card: #252525;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #444444;
            --border-radius: 8px;
            --gradient-primary: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            --gradient-success: linear-gradient(135deg, var(--primary-green), #20c997);
            --transition: all 0.3s ease;
        }
        
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* åº”ç”¨å®¹å™¨å¸ƒå±€ */
        .app-container {
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto 1fr auto;
            grid-template-areas: 
                "header"
                "toolbar"
                "token"
                "main"
                "status";
        }
        
        /* å…¨å±æ¨¡å¼æ ·å¼ */
        .fullscreen {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 9999;
            background: var(--bg-primary);
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas: 
                "fullscreen-toolbar"
                "fullscreen-main";
        }
        
        .fullscreen .header,
        .fullscreen .toolbar,
        .fullscreen .token-section,
        .fullscreen .status-bar {
            display: none;
        }
        
        /* å…¨å±å·¥å…·æ  */
        .fullscreen-toolbar {
            grid-area: fullscreen-toolbar;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--primary-blue);
            padding: 8px 16px;
            display: none;
            justify-content: space-between;
            align-items: center;
        }
        
        .fullscreen .fullscreen-toolbar {
            display: flex;
        }
        
        .fullscreen-main {
            grid-area: fullscreen-main;
        }
        
        .fullscreen .main-content {
            grid-area: fullscreen-main;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            grid-area: header;
            background: var(--gradient-primary);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            z-index: 100;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 1;
        }
        
        .app-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .project-link {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .project-link:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .status-indicator {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--primary-red);
            transition: var(--transition);
        }
        
        .status-dot.connected {
            background: var(--primary-green);
            box-shadow: 0 0 10px var(--primary-green);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1;
        }
        
        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            grid-area: toolbar;
            background: var(--bg-secondary);
            border-bottom: 3px solid var(--primary-blue);
            padding: 12px 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            position: relative;
            z-index: 99;
        }
        
        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            position: relative;
            overflow: hidden;
            padding: 8px 12px;
            font-weight: 500;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            text-decoration: none;
            background: transparent;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }
        
        .btn:hover:not(:disabled)::before { left: 100%; }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.4);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-green);
            color: var(--primary-green);
        }
        
        .btn-outline:hover:not(:disabled) {
            background: var(--primary-green);
            color: white;
        }
        
        .btn-icon {
            width: 36px; height: 36px;
            padding: 0;
            border-radius: 50%;
            font-size: 16px;
        }
        
        /* JSONæ–‡ä»¶é€‰æ‹©å™¨ */
        .json-selector {
            position: relative;
            margin-right: 12px;
        }
        
        .json-selector select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
        }
        
        /* Token è¾“å…¥åŒº */
        .token-section {
            grid-area: token;
            background: var(--bg-card);
            border-bottom: 2px solid var(--primary-blue);
            padding: 16px 24px;
            position: relative;
            z-index: 98;
        }
        
        .token-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        
        .token-input-group {
            max-width: 800px;
        }
        
        .token-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .input-with-button {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .input-with-button input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .input-with-button input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            outline: none;
        }
        
        .help-text {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .help-text a {
            color: var(--primary-blue);
            text-decoration: none;
        }
        
        .help-text code {
            background: var(--bg-tertiary);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            grid-area: main;
            display: flex;
            background: var(--bg-secondary);
            overflow: hidden;
            position: relative;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            margin: 8px 8px 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }
        
        .editor-header {
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .editor {
            flex: 1;
            background: var(--bg-primary);
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            border: none;
            outline: none;
            resize: none;
            padding: 16px;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }
        
        /* æŸ¥æ‰¾æ  */
        .search-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 12px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .search-info {
            color: var(--text-muted);
            font-size: 11px;
        }
        
        /* ä¾§è¾¹æ ï¼ˆæ ‘çŠ¶è§†å›¾å’Œå†å²è®°å½•ï¼‰ */
        .sidebar {
            width: 350px;
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            margin: 8px 8px 8px 0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .sidebar-tabs {
            display: flex;
            background: var(--bg-tertiary);
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 13px;
        }
        
        .sidebar-tab.active {
            background: var(--gradient-primary);
            color: white;
        }
        
        .sidebar-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        /* JSONæ ‘çŠ¶è§†å›¾ */
        .json-tree {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .tree-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .tree-node {
            margin: 2px 0;
            padding: 2px 4px;
            border-radius: 3px;
            transition: var(--transition);
            cursor: pointer;
            user-select: none;
        }
        
        .tree-node:hover {
            background: var(--bg-tertiary);
        }
        
        .tree-key { 
            color: var(--primary-blue); 
            font-weight: 600; 
            margin-right: 8px;
        }
        
        .tree-string { 
            color: var(--primary-green);
        }
        
        .tree-number { 
            color: var(--primary-orange); 
            font-weight: 500; 
        }
        
        .tree-boolean { 
            color: var(--primary-purple); 
            font-weight: 500; 
        }
        
        .tree-null { 
            color: var(--text-muted); 
            font-style: italic; 
        }
        
        .tree-toggle {
            display: inline-block;
            width: 16px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            color: var(--text-muted);
            margin-right: 4px;
        }
        
        .tree-toggle.expanded::before {
            content: 'â–¼';
        }
        
        .tree-toggle.collapsed::before {
            content: 'â–¶';
        }
        
        .tree-indent {
            display: inline-block;
            width: 20px;
        }
        
        .tree-children {
            margin-left: 20px;
        }
        
        .tree-children.collapsed {
            display: none;
        }
        
        /* å†å²è®°å½•æ ·å¼ */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
        }
        
        .history-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-blue);
        }
        
        .history-time {
            color: var(--text-muted);
            font-size: 11px;
            margin-top: 4px;
        }
        
        .history-content {
            font-family: monospace;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            grid-area: status;
            background: var(--bg-card);
            border-top: 2px solid var(--primary-blue);
            padding: 8px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 97;
        }
        
        .status-left, .status-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-valid {
            color: var(--primary-green);
            font-weight: 600;
        }
        
        .status-invalid {
            color: var(--primary-red);
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* é”™è¯¯é¢æ¿ */
        .error-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: var(--primary-red);
            color: white;
            max-height: 200px;
            overflow-y: auto;
            z-index: 200;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        
        .error-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .error-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .error-content {
            padding: 12px 16px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toasté€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .toast {
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: toastSlideIn 0.3s ease-out;
            cursor: pointer;
        }
        
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast.success { background: var(--gradient-success); }
        .toast.error { background: linear-gradient(135deg, var(--primary-red), #e74c3c); }
        .toast.warning { background: linear-gradient(135deg, var(--primary-orange), #ffc107); }
        .toast.info { background: var(--gradient-primary); }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-title { font-size: 16px; }
            .header { padding: 12px 16px; }
            .toolbar { padding: 8px 16px; flex-wrap: wrap; }
            .token-section { padding: 12px 16px; }
            .sidebar { 
                width: 100%; 
                position: fixed; 
                top: 0; right: 0; bottom: 0; 
                z-index: 1000;
                margin: 0;
                border-radius: 0;
            }
            .editor-container {
                margin: 4px;
            }
            .toolbar-section {
                flex-wrap: wrap;
                gap: 4px;
            }
        }
        
        /* é€‰æ‹©æ–‡æœ¬æ ·å¼ */
        ::selection {
            background: var(--primary-blue);
            color: white;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨åŠ è½½ Luna TV é…ç½®ç¼–è¾‘å™¨...</p>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" class="app-container" style="display: none;">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="header-left">
                <h1 class="app-title">ğŸŒ™ Luna TV é…ç½®ç¼–è¾‘å™¨</h1>
                <a href="https://github.com/hafrey1/LunaTV-config" class="project-link" target="_blank">GitHub é¡¹ç›®</a>
                <div class="status-indicator" id="status">
                    <span class="status-dot"></span>
                    <span class="status-text">æœªè¿æ¥</span>
                </div>
            </div>
            
            <div class="header-right">
                <button class="btn btn-icon" id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                <button class="btn btn-icon" id="fullscreen-toggle" title="å…¨å±æ¨¡å¼">â›¶</button>
                <button class="btn btn-primary" id="save-btn" title="ä¿å­˜åˆ° GitHub">ğŸ’¾ ä¿å­˜</button>
            </div>
        </header>

        <!-- å…¨å±å·¥å…·æ  -->
        <div class="fullscreen-toolbar">
            <div class="toolbar-section">
                <button class="btn btn-outline" id="fullscreen-format-btn">ğŸ”§ æ ¼å¼åŒ–</button>
                <button class="btn btn-outline" id="fullscreen-validate-btn">âœ… éªŒè¯</button>
                <button class="btn btn-outline" id="fullscreen-find-btn">ğŸ” æŸ¥æ‰¾</button>
            </div>
            <div class="toolbar-section">
                <button class="btn btn-icon" id="exit-fullscreen-btn" title="é€€å‡ºå…¨å±">ğŸ——</button>
            </div>
        </div>

        <!-- å·¥å…·æ  -->
        <nav class="toolbar">
            <div class="toolbar-section">
                <div class="json-selector">
                    <select id="json-file-select">
                        <option value="">é€‰æ‹©JSONæ–‡ä»¶...</option>
                    </select>
                </div>
                <button class="btn btn-secondary" id="refresh-files-btn">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-secondary" id="upload-btn">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</button>
                <button class="btn btn-secondary" id="download-btn">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</button>
            </div>
            
            <div class="toolbar-section">
                <button class="btn btn-outline" id="format-btn">ğŸ”§ æ ¼å¼åŒ–</button>
                <button class="btn btn-outline" id="compress-btn">ğŸ“¦ å‹ç¼©</button>
                <button class="btn btn-outline" id="validate-btn">âœ… éªŒè¯</button>
            </div>
            
            <div class="toolbar-section">
                <button class="btn btn-outline" id="copy-btn">ğŸ“‹ å¤åˆ¶</button>
                <button class="btn btn-outline" id="find-btn">ğŸ” æŸ¥æ‰¾</button>
                <button class="btn btn-outline" id="undo-btn" disabled>â†¶ æ’¤é”€</button>
                <button class="btn btn-outline" id="redo-btn" disabled>â†· é‡åš</button>
            </div>
            
            <div class="toolbar-section">
                <select id="view-mode" class="btn btn-secondary">
                    <option value="editor">ç¼–è¾‘å™¨</option>
                    <option value="tree">æ ‘çŠ¶å›¾</option>
                    <option value="split">åˆ†å±</option>
                </select>
            </div>
        </nav>

        <!-- GitHub Token è¾“å…¥ -->
        <div id="token-section" class="token-section">
            <div class="token-input-group">
                <label for="github-token">ğŸ”‘ GitHub Personal Access Token:</label>
                <div class="input-with-button">
                    <input 
                        type="password" 
                        id="github-token" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„ GitHub Token (éœ€è¦ repo æƒé™)" 
                        autocomplete="current-password"
                    >
                    <button class="btn btn-primary" id="connect-btn">è¿æ¥</button>
                </div>
                <small class="help-text">
                    éœ€è¦ <code>repo</code> æƒé™ã€‚<a href="https://github.com/settings/tokens" target="_blank">è·å– Token</a> | 
                    <a href="#" id="demo-mode">ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼</a>
                </small>
            </div>
        </div>

        <!-- ä¸»ç¼–è¾‘åŒº -->
        <main class="main-content">
            <div class="editor-container">
                <div class="editor-header">
                    <span id="current-file">æ–°å»ºæ–‡ä»¶</span>
                    <div class="editor-actions">
                        <button class="btn btn-outline btn-sm" id="editor-find-btn" title="åœ¨ç¼–è¾‘å™¨ä¸­æŸ¥æ‰¾ (Ctrl+F)">ğŸ”</button>
                    </div>
                </div>
                
                <!-- æŸ¥æ‰¾æ  -->
                <div class="search-bar" id="search-bar">
                    <input type="text" id="search-input" placeholder="æŸ¥æ‰¾å†…å®¹...">
                    <button class="btn btn-outline btn-sm" id="search-prev">â†‘</button>
                    <button class="btn btn-outline btn-sm" id="search-next">â†“</button>
                    <span class="search-info" id="search-info">0/0</span>
                    <button class="btn btn-outline btn-sm" id="search-close">âœ•</button>
                </div>
                
                <textarea id="monaco-editor" class="editor" placeholder="è¯·è¾“å…¥JSONé…ç½®æ–‡ä»¶å†…å®¹...">{
  "sites": [],
  "wallpaper": "",
  "spider": "",
  "warningText": "",
  "disclaimer": "",
  "version": "1.0.0"
}</textarea>
                
                <!-- é”™è¯¯é¢æ¿ -->
                <div id="error-panel" class="error-panel" style="display: none;">
                    <div class="error-header">
                        <span>âš ï¸ JSON æ ¼å¼é”™è¯¯</span>
                        <button class="error-close" id="close-error">âœ•</button>
                    </div>
                    <div class="error-content" id="error-message"></div>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar" id="sidebar" style="display: none;">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="tree">ğŸ“Š æ ‘çŠ¶å›¾</button>
                    <button class="sidebar-tab" data-tab="history">ğŸ“š å†å²</button>
                </div>
                
                <div class="sidebar-content">
                    <!-- æ ‘çŠ¶å›¾è§†å›¾ -->
                    <div id="tree-tab-content" class="tab-content">
                        <div class="sidebar-header">
                            <h4>JSON æ ‘çŠ¶è§†å›¾</h4>
                            <button class="btn btn-icon" id="close-sidebar">âœ•</button>
                        </div>
                        <div class="tree-controls">
                            <button class="btn btn-outline btn-sm" id="expand-all">ğŸ”½ å…¨éƒ¨å±•å¼€</button>
                            <button class="btn btn-outline btn-sm" id="collapse-all">ğŸ”¼ å…¨éƒ¨æŠ˜å </button>
                        </div>
                        <div id="json-tree" class="json-tree"></div>
                    </div>
                    
                    <!-- å†å²è®°å½•è§†å›¾ -->
                    <div id="history-tab-content" class="tab-content" style="display: none;">
                        <div class="sidebar-header">
                            <h4>ğŸ“š å†å²è®°å½•</h4>
                            <button class="btn btn-outline btn-sm" id="clear-history">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                        <div class="history-list" id="history-list">
                            <!-- åŠ¨æ€ç”Ÿæˆå†å²è®°å½• -->
                        </div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- çŠ¶æ€æ  -->
        <footer class="status-bar">
            <div class="status-left">
                <span id="cursor-position">è¡Œ 1, åˆ— 1</span>
                <span id="file-size">0 å­—ç¬¦</span>
                <span id="encoding">UTF-8</span>
                <span id="auto-save-status">è‡ªåŠ¨ä¿å­˜: å¼€å¯</span>
            </div>
            
            <div class="status-right">
                <span id="last-saved">æœªä¿å­˜</span>
                <span id="json-status" class="status-valid">JSON æœ‰æ•ˆ</span>
            </div>
        </footer>
    </div>

    <!-- Toasté€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="file-input" accept=".json" style="display: none;">

    <script>
        // ç®€åŒ–ç‰ˆJavaScriptåº”ç”¨
        class LunaTVEditor {
            constructor() {
                this.isConnected = false;
                this.currentTheme = 'dark';
                this.viewMode = 'editor';
                this.history = [];
                this.historyIndex = -1;
                this.autoSaveInterval = null;
                this.lastContent = '';
                this.isFullscreen = false;
                this.jsonFiles = [];
                this.currentFile = null;
                this.searchMatches = [];
                this.currentSearchIndex = -1;
                this.sidebarTab = 'tree';
            }
            
            init() {
                this.hideLoading();
                this.setupEventListeners();
                this.loadSettings();
                this.startAutoSave();
                this.updateStatus();
                this.loadJSONFiles();
                console.log('ğŸŒ™ Luna TV é…ç½®ç¼–è¾‘å™¨å·²å¯åŠ¨');
            }
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'grid';
            }
            
            setupEventListeners() {
                const editor = document.getElementById('monaco-editor');
                
                // ç¼–è¾‘å™¨äº‹ä»¶
                editor.addEventListener('input', () => this.onContentChange());
                editor.addEventListener('keydown', (e) => this.handleKeyDown(e));
                editor.addEventListener('scroll', () => this.updateCursorPosition());
                editor.addEventListener('click', () => this.updateCursorPosition());
                
                // æŒ‰é’®äº‹ä»¶
                document.getElementById('save-btn').onclick = () => this.saveToGitHub();
                document.getElementById('refresh-files-btn').onclick = () => this.loadJSONFiles();
                document.getElementById('upload-btn').onclick = () => this.uploadFile();
                document.getElementById('download-btn').onclick = () => this.downloadFile();
                
                document.getElementById('format-btn').onclick = () => this.formatJSON();
                document.getElementById('compress-btn').onclick = () => this.compressJSON();
                document.getElementById('validate-btn').onclick = () => this.validateJSON();
                document.getElementById('copy-btn').onclick = () => this.copyToClipboard();
                document.getElementById('find-btn').onclick = () => this.showFind();
                document.getElementById('editor-find-btn').onclick = () => this.showFind();
                
                document.getElementById('undo-btn').onclick = () => this.undo();
                document.getElementById('redo-btn').onclick = () => this.redo();
                
                document.getElementById('theme-toggle').onclick = () => this.toggleTheme();
                document.getElementById('fullscreen-toggle').onclick = () => this.toggleFullscreen();
                document.getElementById('exit-fullscreen-btn').onclick = () => this.toggleFullscreen();
                
                // å…¨å±å·¥å…·æ æŒ‰é’®
                document.getElementById('fullscreen-format-btn').onclick = () => this.formatJSON();
                document.getElementById('fullscreen-validate-btn').onclick = () => this.validateJSON();
                document.getElementById('fullscreen-find-btn').onclick = () => this.showFind();
                
                document.getElementById('view-mode').onchange = (e) => this.changeViewMode(e.target.value);
                document.getElementById('json-file-select').onchange = (e) => this.selectJSONFile(e.target.value);
                
                // GitHubè¿æ¥
                document.getElementById('connect-btn').onclick = () => this.connectGitHub();
                document.getElementById('demo-mode').onclick = (e) => {
                    e.preventDefault();
                    this.enterDemoMode();
                };
                
                // å…³é—­æŒ‰é’®
                document.getElementById('close-error').onclick = () => this.hideError();
                document.getElementById('close-sidebar').onclick = () => this.closeSidebar();
                
                // æ–‡ä»¶è¾“å…¥
                document.getElementById('file-input').onchange = (e) => this.handleFileUpload(e);
                
                // ä¾§è¾¹æ æ ‡ç­¾
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.onclick = () => this.switchSidebarTab(tab.dataset.tab);
                });
                
                // æ ‘çŠ¶å›¾æ§åˆ¶
                document.getElementById('expand-all').onclick = () => this.expandAllTree();
                document.getElementById('collapse-all').onclick = () => this.collapseAllTree();
                
                // å†å²è®°å½•
                document.getElementById('clear-history').onclick = () => this.clearHistory();
                
                // æŸ¥æ‰¾åŠŸèƒ½
                document.getElementById('search-input').addEventListener('input', (e) => this.performSearch(e.target.value));
                document.getElementById('search-prev').onclick = () => this.searchPrevious();
                document.getElementById('search-next').onclick = () => this.searchNext();
                document.getElementById('search-close').onclick = () => this.hideFind();
                
                // æŸ¥æ‰¾æ æŒ‰é”®
                document.getElementById('search-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        if (e.shiftKey) {
                            this.searchPrevious();
                        } else {
                            this.searchNext();
                        }
                    } else if (e.key === 'Escape') {
                        this.hideFind();
                    }
                });
            }
            
            onContentChange() {
                const content = document.getElementById('monaco-editor').value;
                this.updateFileSize(content);
                this.validateJSON();
                
                if (content !== this.lastContent) {
                    this.saveToHistory(content);
                    this.lastContent = content;
                    this.updateSaveStatus(false);
                    this.updateTreeView();
                }
            }
            
            handleKeyDown(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            this.saveToGitHub();
                            break;
                        case 'f':
                            e.preventDefault();
                            this.showFind();
                            break;
                        case 'z':
                            if (e.shiftKey) {
                                e.preventDefault();
                                this.redo();
                            } else {
                                e.preventDefault();
                                this.undo();
                            }
                            break;
                    }
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    this.toggleFullscreen();
                }
                
                if (e.key === 'Escape') {
                    this.hideFind();
                }
            }
            
            // JSONæ–‡ä»¶ç®¡ç†
            async loadJSONFiles() {
                if (!this.isConnected) {
                    // æ¼”ç¤ºæ¨¡å¼çš„æ ·ä¾‹æ–‡ä»¶
                    this.jsonFiles = [
                        { name: 'config.json', path: 'config.json' },
                        { name: 'tv-sources.json', path: 'tv-sources.json' },
                        { name: 'settings.json', path: 'settings.json' }
                    ];
                } else {
                    try {
                        // å®é™…åº”è¯¥è°ƒç”¨GitHub APIè·å–ä»“åº“æ ¹ç›®å½•çš„æ‰€æœ‰JSONæ–‡ä»¶
                        // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        this.jsonFiles = [
                            { name: 'luna-tv-config.json', path: 'luna-tv-config.json' },
                            { name: 'backup-config.json', path: 'backup-config.json' },
                            { name: 'test-config.json', path: 'test-config.json' }
                        ];
                    } catch (error) {
                        this.showToast('åŠ è½½JSONæ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                        return;
                    }
                }
                
                this.updateFileSelector();
            }
            
            updateFileSelector() {
                const select = document.getElementById('json-file-select');
                select.innerHTML = '<option value="">é€‰æ‹©JSONæ–‡ä»¶...</option>';
                
                this.jsonFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.name;
                    select.appendChild(option);
                });
            }
            
            async selectJSONFile(filePath) {
                if (!filePath) return;
                
                try {
                    this.currentFile = filePath;
                    document.getElementById('current-file').textContent = filePath;
                    
                    // æ¨¡æ‹ŸåŠ è½½æ–‡ä»¶å†…å®¹
                    const sampleConfigs = {
                        'luna-tv-config.json': {
                            "sites": [
                                {
                                    "key": "csp_XYQHiker",
                                    "name": "é¦™é›…æƒ…",
                                    "type": 3,
                                    "api": "csp_XYQHiker",
                                    "searchable": 1,
                                    "quickSearch": 1,
                                    "filterable": 1
                                }
                            ],
                            "wallpaper": "https://picsum.photos/1920/1080",
                            "spider": "https://raw.githubusercontent.com/user/repo/main/spider.jar",
                            "warningText": "æœ¬åº”ç”¨ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨",
                            "disclaimer": "å…è´£å£°æ˜å†…å®¹",
                            "version": "1.2.0"
                        },
                        'tv-sources.json': {
                            "sources": [
                                { "name": "CCTV-1", "url": "186" },
                                { "name": "CCTV-2", "url": "187" }
                            ]
                        },
                        'config.json': {
                            "app_name": "Luna TV",
                            "version": "2.0.0",
                            "settings": {
                                "auto_update": true,
                                "cache_size": 100
                            }
                        }
                    };
                    
                    const content = sampleConfigs[filePath] || { "message": "æ–‡ä»¶å†…å®¹" };
                    document.getElementById('monaco-editor').value = JSON.stringify(content, null, 2);
                    this.onContentChange();
                    
                    this.showToast(`å·²åŠ è½½æ–‡ä»¶: ${filePath}`, 'success');
                } catch (error) {
                    this.showToast('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            // æ ¼å¼åŒ–JSON
            formatJSON() {
                try {
                    const content = document.getElementById('monaco-editor').value;
                    const parsed = JSON.parse(content);
                    const formatted = JSON.stringify(parsed, null, 2);
                    document.getElementById('monaco-editor').value = formatted;
                    this.showToast('JSONæ ¼å¼åŒ–æˆåŠŸ', 'success');
                    this.onContentChange();
                } catch (e) {
                    this.showToast('JSONæ ¼å¼åŒ–å¤±è´¥: ' + e.message, 'error');
                }
            }
            
            // å‹ç¼©JSON
            compressJSON() {
                try {
                    const content = document.getElementById('monaco-editor').value;
                    const parsed = JSON.parse(content);
                    const compressed = JSON.stringify(parsed);
                    document.getElementById('monaco-editor').value = compressed;
                    this.showToast('JSONå‹ç¼©æˆåŠŸ', 'success');
                    this.onContentChange();
                } catch (e) {
                    this.showToast('JSONå‹ç¼©å¤±è´¥: ' + e.message, 'error');
                }
            }
            
            // éªŒè¯JSON
            validateJSON() {
                const content = document.getElementById('monaco-editor').value;
                const jsonStatus = document.getElementById('json-status');
                
                try {
                    JSON.parse(content);
                    jsonStatus.textContent = 'JSON æœ‰æ•ˆ';
                    jsonStatus.className = 'status-valid';
                    this.hideError();
                    return true;
                } catch (e) {
                    jsonStatus.textContent = 'JSON æ— æ•ˆ';
                    jsonStatus.className = 'status-invalid';
                    this.showError('JSONæ ¼å¼é”™è¯¯: ' + e.message);
                    return false;
                }
            }
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            async copyToClipboard() {
                try {
                    const content = document.getElementById('monaco-editor').value;
                    await navigator.clipboard.writeText(content);
                    this.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } catch (e) {
                    this.showToast('å¤åˆ¶å¤±è´¥: ' + e.message, 'error');
                }
            }
            
            // æŸ¥æ‰¾åŠŸèƒ½
            showFind() {
                const searchBar = document.getElementById('search-bar');
                const searchInput = document.getElementById('search-input');
                
                searchBar.style.display = 'flex';
                searchInput.focus();
                
                // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œè‡ªåŠ¨å¡«å…¥æŸ¥æ‰¾æ¡†
                const editor = document.getElementById('monaco-editor');
                const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                if (selectedText) {
                    searchInput.value = selectedText;
                    this.performSearch(selectedText);
                }
            }
            
            hideFind() {
                const searchBar = document.getElementById('search-bar');
                searchBar.style.display = 'none';
                this.clearSearchHighlight();
            }
            
            performSearch(query) {
                const editor = document.getElementById('monaco-editor');
                const content = editor.value;
                this.searchMatches = [];
                
                if (!query) {
                    this.updateSearchInfo();
                    this.clearSearchHighlight();
                    return;
                }
                
                // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹
                let index = content.indexOf(query);
                while (index !== -1) {
                    this.searchMatches.push({ start: index, end: index + query.length });
                    index = content.indexOf(query, index + 1);
                }
                
                this.currentSearchIndex = this.searchMatches.length > 0 ? 0 : -1;
                this.updateSearchInfo();
                this.highlightSearch();
                
                if (this.searchMatches.length > 0) {
                    this.jumpToSearchMatch(0);
                }
            }
            
            searchNext() {
                if (this.searchMatches.length === 0) return;
                
                this.currentSearchIndex = (this.currentSearchIndex + 1) % this.searchMatches.length;
                this.jumpToSearchMatch(this.currentSearchIndex);
                this.updateSearchInfo();
            }
            
            searchPrevious() {
                if (this.searchMatches.length === 0) return;
                
                this.currentSearchIndex = this.currentSearchIndex === 0 ? 
                    this.searchMatches.length - 1 : this.currentSearchIndex - 1;
                this.jumpToSearchMatch(this.currentSearchIndex);
                this.updateSearchInfo();
            }
            
            jumpToSearchMatch(index) {
                if (index < 0 || index >= this.searchMatches.length) return;
                
                const editor = document.getElementById('monaco-editor');
                const match = this.searchMatches[index];
                
                editor.focus();
                editor.setSelectionRange(match.start, match.end);
                
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                const lines = editor.value.substring(0, match.start).split('\n');
                const lineNumber = lines.length;
                const lineHeight = 20; // ä¼°ç®—è¡Œé«˜
                const scrollTop = Math.max(0, (lineNumber - 5) * lineHeight);
                editor.scrollTop = scrollTop;
            }
            
            updateSearchInfo() {
                const searchInfo = document.getElementById('search-info');
                if (this.searchMatches.length === 0) {
                    searchInfo.textContent = '0/0';
                } else {
                    searchInfo.textContent = `${this.currentSearchIndex + 1}/${this.searchMatches.length}`;
                }
            }
            
            highlightSearch() {
                // ç®€åŒ–ç‰ˆé«˜äº®ï¼Œå®é™…åº”è¯¥ä¿®æ”¹ç¼–è¾‘å™¨æ ·å¼
                // è¿™é‡Œåªæ˜¯æ›´æ–°æœç´¢ä¿¡æ¯
                this.updateSearchInfo();
            }
            
            clearSearchHighlight() {
                this.searchMatches = [];
                this.currentSearchIndex = -1;
                this.updateSearchInfo();
            }
            
            // æ’¤é”€
            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    document.getElementById('monaco-editor').value = this.history[this.historyIndex];
                    this.updateUndoRedoButtons();
                    this.showToast('å·²æ’¤é”€', 'info');
                }
            }
            
            // é‡åš
            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    document.getElementById('monaco-editor').value = this.history[this.historyIndex];
                    this.updateUndoRedoButtons();
                    this.showToast('å·²é‡åš', 'info');
                }
            }
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            saveToHistory(content) {
                // å¦‚æœå†…å®¹ç›¸åŒï¼Œä¸ä¿å­˜
                if (this.history[this.historyIndex] === content) return;
                
                // ç§»é™¤å½“å‰ä½ç½®ä¹‹åçš„å†å²è®°å½•
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                // æ·»åŠ æ–°è®°å½•
                this.history.push(content);
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (this.history.length > 50) {
                    this.history.shift();
                } else {
                    this.historyIndex++;
                }
                
                this.updateUndoRedoButtons();
                this.updateHistoryPanel();
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('lunatv_history', JSON.stringify({
                    history: this.history,
                    index: this.historyIndex
                }));
            }
            
            // æ›´æ–°æ’¤é”€é‡åšæŒ‰é’®çŠ¶æ€
            updateUndoRedoButtons() {
                document.getElementById('undo-btn').disabled = this.historyIndex <= 0;
                document.getElementById('redo-btn').disabled = this.historyIndex >= this.history.length - 1;
            }
            
            // åˆ‡æ¢å…¨å±
            toggleFullscreen() {
                const app = document.getElementById('app');
                this.isFullscreen = !this.isFullscreen;
                
                if (this.isFullscreen) {
                    app.classList.add('fullscreen');
                    document.getElementById('fullscreen-toggle').textContent = 'ğŸ——';
                } else {
                    app.classList.remove('fullscreen');
                    document.getElementById('fullscreen-toggle').textContent = 'â›¶';
                }
            }
            
            // åˆ‡æ¢ä¸»é¢˜
            toggleTheme() {
                this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', this.currentTheme);
                localStorage.setItem('lunatv_theme', this.currentTheme);
                this.showToast(`å·²åˆ‡æ¢åˆ°${this.currentTheme === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}ä¸»é¢˜`, 'info');
            }
            
            // ä¾§è¾¹æ ç®¡ç†
            switchSidebarTab(tabName) {
                this.sidebarTab = tabName;
                
                // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });
                
                // åˆ‡æ¢å†…å®¹
                document.getElementById('tree-tab-content').style.display = 
                    tabName === 'tree' ? 'block' : 'none';
                document.getElementById('history-tab-content').style.display = 
                    tabName === 'history' ? 'block' : 'none';
                
                if (tabName === 'tree') {
                    this.updateTreeView();
                } else if (tabName === 'history') {
                    this.updateHistoryPanel();
                }
            }
            
            // æ›´æ”¹è§†å›¾æ¨¡å¼
            changeViewMode(mode) {
                this.viewMode = mode;
                const sidebar = document.getElementById('sidebar');
                
                switch (mode) {
                    case 'tree':
                        sidebar.style.display = 'flex';
                        this.switchSidebarTab('tree');
                        this.updateTreeView();
                        break;
                    case 'split':
                        sidebar.style.display = 'flex';
                        this.switchSidebarTab('tree');
                        this.updateTreeView();
                        break;
                    default:
                        sidebar.style.display = 'none';
                }
                
                localStorage.setItem('lunatv_viewMode', mode);
            }
            
            closeSidebar() {
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('view-mode').value = 'editor';
                this.viewMode = 'editor';
            }
            
            // æ›´æ–°æ ‘çŠ¶è§†å›¾
            updateTreeView() {
                if (this.viewMode === 'tree' || this.viewMode === 'split') {
                    const content = document.getElementById('monaco-editor').value;
                    const treeContainer = document.getElementById('json-tree');
                    
                    try {
                        const json = JSON.parse(content);
                        treeContainer.innerHTML = this.generateTreeHTML(json, 0, 'root');
                        this.setupTreeEvents();
                    } catch (e) {
                        treeContainer.innerHTML = '<div class="tree-error">JSONæ ¼å¼æ— æ•ˆï¼Œæ— æ³•æ˜¾ç¤ºæ ‘çŠ¶è§†å›¾</div>';
                    }
                }
            }
            
            // ç”Ÿæˆæ ‘çŠ¶HTML
            generateTreeHTML(obj, level, key) {
                const indent = level * 20;
                let html = '';
                
                if (Array.isArray(obj)) {
                    html += `<div class="tree-node" style="margin-left: ${indent}px;">`;
                    html += `<span class="tree-toggle collapsed" data-path="${key}"></span>`;
                    html += `<span class="tree-key">${key}: </span>`;
                    html += `<span class="tree-bracket">[${obj.length}]</span>`;
                    html += `</div>`;
                    
                    html += `<div class="tree-children collapsed" data-parent="${key}">`;
                    obj.forEach((item, index) => {
                        const itemKey = `${key}[${index}]`;
                        html += this.generateTreeHTML(item, level + 1, index);
                    });
                    html += `</div>`;
                    
                } else if (typeof obj === 'object' && obj !== null) {
                    const keys = Object.keys(obj);
                    html += `<div class="tree-node" style="margin-left: ${indent}px;">`;
                    html += `<span class="tree-toggle collapsed" data-path="${key}"></span>`;
                    html += `<span class="tree-key">${key}: </span>`;
                    html += `<span class="tree-bracket">{${keys.length}}</span>`;
                    html += `</div>`;
                    
                    html += `<div class="tree-children collapsed" data-parent="${key}">`;
                    keys.forEach(objKey => {
                        const itemKey = `${key}.${objKey}`;
                        html += this.generateTreeHTML(obj[objKey], level + 1, objKey);
                    });
                    html += `</div>`;
                    
                } else {
                    html += `<div class="tree-node" style="margin-left: ${indent}px;">`;
                    html += `<span class="tree-indent"></span>`;
                    html += `<span class="tree-key">${key}: </span>`;
                    html += `<span class="tree-${typeof obj}">${JSON.stringify(obj)}</span>`;
                    html += `</div>`;
                }
                
                return html;
            }
            
            // è®¾ç½®æ ‘çŠ¶å›¾äº‹ä»¶
            setupTreeEvents() {
                document.querySelectorAll('.tree-toggle').forEach(toggle => {
                    toggle.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleTreeNode(toggle);
                    };
                });
            }
            
            // åˆ‡æ¢æ ‘èŠ‚ç‚¹
            toggleTreeNode(toggle) {
                const path = toggle.dataset.path;
                const children = document.querySelector(`.tree-children[data-parent="${path}"]`);
                
                if (children) {
                    const isCollapsed = children.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        children.classList.remove('collapsed');
                        toggle.classList.remove('collapsed');
                        toggle.classList.add('expanded');
                    } else {
                        children.classList.add('collapsed');
                        toggle.classList.remove('expanded');
                        toggle.classList.add('collapsed');
                    }
                }
            }
            
            // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
            expandAllTree() {
                document.querySelectorAll('.tree-children').forEach(children => {
                    children.classList.remove('collapsed');
                });
                document.querySelectorAll('.tree-toggle').forEach(toggle => {
                    toggle.classList.remove('collapsed');
                    toggle.classList.add('expanded');
                });
            }
            
            // æŠ˜å æ‰€æœ‰èŠ‚ç‚¹
            collapseAllTree() {
                document.querySelectorAll('.tree-children').forEach(children => {
                    children.classList.add('collapsed');
                });
                document.querySelectorAll('.tree-toggle').forEach(toggle => {
                    toggle.classList.remove('expanded');
                    toggle.classList.add('collapsed');
                });
            }
            
            // GitHubç›¸å…³æ–¹æ³•
            connectGitHub() {
                const token = document.getElementById('github-token').value.trim();
                if (!token) {
                    this.showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„GitHub Token', 'error');
                    return;
                }
                
                // ç®€å•éªŒè¯ï¼ˆå®é™…åº”è¯¥è°ƒç”¨GitHub APIéªŒè¯ï¼‰
                this.isConnected = true;
                this.updateConnectionStatus();
                this.showToast('GitHubè¿æ¥æˆåŠŸ', 'success');
                this.loadJSONFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                localStorage.setItem('lunatv_github_connected', 'true');
            }
            
            enterDemoMode() {
                this.isConnected = true;
                this.updateConnectionStatus();
                this.showToast('å·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼', 'info');
                this.loadJSONFiles(); // åŠ è½½æ¼”ç¤ºæ–‡ä»¶
                
                // éšè—tokenè¾“å…¥åŒº
                document.getElementById('token-section').style.display = 'none';
            }
            
            updateConnectionStatus() {
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.querySelector('.status-text');
                const tokenSection = document.getElementById('token-section');
                
                if (this.isConnected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'å·²è¿æ¥';
                    tokenSection.style.display = 'none';
                    
                    // å¯ç”¨ç›¸å…³æŒ‰é’®
                    document.getElementById('save-btn').disabled = false;
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'æœªè¿æ¥';
                    tokenSection.style.display = 'block';
                    
                    // ç¦ç”¨ç›¸å…³æŒ‰é’®
                    document.getElementById('save-btn').disabled = true;
                }
            }
            
            async saveToGitHub() {
                if (!this.isConnected) {
                    this.showToast('è¯·å…ˆè¿æ¥GitHub', 'error');
                    return;
                }
                
                const content = document.getElementById('monaco-editor').value;
                if (!this.validateJSON()) {
                    this.showToast('ä¿å­˜å¤±è´¥: JSONæ ¼å¼æ— æ•ˆ', 'error');
                    return;
                }
                
                if (!this.currentFile) {
                    this.showToast('è¯·å…ˆé€‰æ‹©è¦ä¿å­˜çš„æ–‡ä»¶', 'error');
                    return;
                }
                
                // æ¨¡æ‹Ÿä¿å­˜åˆ°GitHub
                setTimeout(() => {
                    this.updateSaveStatus(true);
                    this.showToast(`é…ç½®å·²ä¿å­˜åˆ°GitHub: ${this.currentFile}`, 'success');
                }, 1000);
            }
            
            // æ–‡ä»¶æ“ä½œ
            uploadFile() {
                document.getElementById('file-input').click();
            }
            
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    document.getElementById('monaco-editor').value = content;
                    this.onContentChange();
                    this.showToast(`æ–‡ä»¶ "${file.name}" ä¸Šä¼ æˆåŠŸ`, 'success');
                    
                    // æ›´æ–°å½“å‰æ–‡ä»¶å
                    this.currentFile = file.name;
                    document.getElementById('current-file').textContent = file.name;
                };
                reader.readAsText(file);
                
                // æ¸…ç©ºè¾“å…¥
                event.target.value = '';
            }
            
            downloadFile() {
                const content = document.getElementById('monaco-editor').value;
                const filename = this.currentFile || `luna-tv-config-${new Date().toISOString().split('T')[0]}.json`;
                
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('æ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
            }
            
            // å†å²è®°å½•ç®¡ç†
            updateHistoryPanel() {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                
                if (this.history.length === 0) {
                    list.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }
                
                this.history.slice().reverse().forEach((content, reverseIndex) => {
                    const index = this.history.length - 1 - reverseIndex;
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    const preview = content.substring(0, 100).replace(/\n/g, ' ');
                    const time = new Date(Date.now() - (reverseIndex * 60000)).toLocaleString();
                    
                    item.innerHTML = `
                        <div class="history-content">${preview}${content.length > 100 ? '...' : ''}</div>
                        <div class="history-time">ç‰ˆæœ¬ ${index + 1} - ${time}</div>
                    `;
                    
                    item.onclick = () => {
                        document.getElementById('monaco-editor').value = content;
                        this.historyIndex = index;
                        this.onContentChange();
                        this.showToast('å·²æ¢å¤å†å²ç‰ˆæœ¬', 'success');
                    };
                    
                    list.appendChild(item);
                });
            }
            
            clearHistory() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                    this.history = [];
                    this.historyIndex = -1;
                    this.updateUndoRedoButtons();
                    this.updateHistoryPanel();
                    localStorage.removeItem('lunatv_history');
                    this.showToast('å†å²è®°å½•å·²æ¸…é™¤', 'info');
                }
            }
            
            // è‡ªåŠ¨ä¿å­˜
            startAutoSave() {
                this.autoSaveInterval = setInterval(() => {
                    const content = document.getElementById('monaco-editor').value;
                    if (content !== this.lastContent && this.validateJSON()) {
                        localStorage.setItem('lunatv_autosave', content);
                        localStorage.setItem('lunatv_autosave_time', Date.now());
                        this.updateAutoSaveStatus('åˆšåˆšè‡ªåŠ¨ä¿å­˜');
                    }
                }, 30000); // 30ç§’è‡ªåŠ¨ä¿å­˜
            }
            
            updateAutoSaveStatus(text) {
                const status = document.getElementById('auto-save-status');
                if (status) {
                    status.textContent = `è‡ªåŠ¨ä¿å­˜: ${text}`;
                }
            }
            
            updateSaveStatus(saved) {
                const status = document.getElementById('last-saved');
                if (saved) {
                    status.textContent = 'å·²ä¿å­˜';
                    setTimeout(() => {
                        if (status.textContent === 'å·²ä¿å­˜') {
                            status.textContent = 'åˆšåˆšä¿å­˜';
                        }
                    }, 2000);
                } else {
                    status.textContent = 'æœªä¿å­˜';
                }
            }
            
            // å·¥å…·æ–¹æ³•
            updateFileSize(content) {
                const size = new Blob([content]).size;
                const sizeElement = document.getElementById('file-size');
                if (sizeElement) {
                    sizeElement.textContent = `${size} å­—ç¬¦`;
                }
            }
            
            updateCursorPosition() {
                const editor = document.getElementById('monaco-editor');
                const position = editor.selectionStart;
                const content = editor.value.substring(0, position);
                const lines = content.split('\n');
                const line = lines.length;
                const column = lines[lines.length - 1].length + 1;
                
                document.getElementById('cursor-position').textContent = `è¡Œ ${line}, åˆ— ${column}`;
            }
            
            updateStatus() {
                // æ›´æ–°å…‰æ ‡ä½ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰
                const editor = document.getElementById('monaco-editor');
                editor.addEventListener('selectionchange', () => {
                    this.updateCursorPosition();
                });
            }
            
            showError(message) {
                const errorPanel = document.getElementById('error-panel');
                const errorMessage = document.getElementById('error-message');
                
                errorMessage.textContent = message;
                errorPanel.style.display = 'block';
            }
            
            hideError() {
                document.getElementById('error-panel').style.display = 'none';
            }
            
            showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                // ç‚¹å‡»å…³é—­
                toast.onclick = () => toast.remove();
                
                // è‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, duration);
            }
            
            // åŠ è½½è®¾ç½®
            loadSettings() {
                const theme = localStorage.getItem('lunatv_theme') || 'dark';
                this.currentTheme = theme;
                document.body.setAttribute('data-theme', theme);
                
                const viewMode = localStorage.getItem('lunatv_viewMode') || 'editor';
                document.getElementById('view-mode').value = viewMode;
                this.changeViewMode(viewMode);
                
                // åŠ è½½å†å²è®°å½•
                const historyData = localStorage.getItem('lunatv_history');
                if (historyData) {
                    try {
                        const parsed = JSON.parse(historyData);
                        this.history = parsed.history || [];
                        this.historyIndex = parsed.index || -1;
                        this.updateUndoRedoButtons();
                    } catch (e) {
                        console.warn('å†å²è®°å½•åŠ è½½å¤±è´¥:', e);
                    }
                }
                
                // åŠ è½½è‡ªåŠ¨ä¿å­˜çš„å†…å®¹
                const autoSaved = localStorage.getItem('lunatv_autosave');
                const autoSaveTime = localStorage.getItem('lunatv_autosave_time');
                if (autoSaved && autoSaveTime) {
                    const timeDiff = Date.now() - parseInt(autoSaveTime);
                    if (timeDiff < 24 * 60 * 60 * 1000) { // 24å°æ—¶å†…
                        if (confirm('æ£€æµ‹åˆ°è‡ªåŠ¨ä¿å­˜çš„å†…å®¹ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ')) {
                            document.getElementById('monaco-editor').value = autoSaved;
                            this.onContentChange();
                        }
                    }
                }
                
                // æ£€æŸ¥GitHubè¿æ¥çŠ¶æ€
                if (localStorage.getItem('lunatv_github_connected') === 'true') {
                    this.isConnected = true;
                    this.updateConnectionStatus();
                }
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        const app = new LunaTVEditor();
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
        
        // å…¨å±€å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // ESCé”®å…³é—­é¢æ¿
                app.closeHistory();
                app.closeSidePanel();
                app.hideError();
            }
        });
        
        console.log('ğŸŒ™ Luna TV é…ç½®ç¼–è¾‘å™¨ v2.0 - åŠŸèƒ½å®Œå–„ç‰ˆ');
    </script>
</body>
</html>
